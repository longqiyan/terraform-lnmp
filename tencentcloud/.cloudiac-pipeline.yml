---
version: 0.5

plan:
  steps:
    terraformPlan:
      before:
        - |
          test -f ansible/export.yml || cd /cloudiac/workspace/code
          bash ansible/run.sh export.yml
          pwd
          sleep 30 &
          jobs -l
          wait

    ansiblePlay:
      after:
        - |
          test -f ansible/import.yml || cd /cloudiac/workspace/code
          bash ansible/run.sh import.yml
          pwd
#apply:
#  steps:
#    terraformApply:
#      before:
#        - |
#          test -f ansible/export.yml || cd /cloudiac/workspace/code
#          bash ansible/run.sh export.yml
#          pwd
#          sleep 30 &
#          jobs -l
#          wait
#          terraform refresh --input=false --var-file=/cloudiac/workspace/_cloudiac.tfvars.json

    ansiblePlay:
      after:
        - |
          test -f ansible/import.yml || cd /cloudiac/workspace/code
          bash ansible/run.sh import.yml
          pwd

destroy:
  steps:
    terraformDestroy:
      before:
        - |
          test -f ansible/export.yml || cd /cloudiac/workspace/code
          bash ansible/run.sh export.yml
          pwd
