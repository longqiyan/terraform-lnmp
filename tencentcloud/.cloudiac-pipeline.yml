---
version: 0.5

apply:
  steps:
    terraformApply:
      before:
        - |
          test -f ansible/export.yml || cd /cloudiac/workspace/code
          bash ansible/run.sh export.yml
          pwd
          sleep 30 &
          jobs -l
          wait
          terraform refresh 
          terraform plan -input=false -out=_cloudiac.tfplan \
          -var-file=v0.9.8_dev_ydd.tfvars -var-file=../../_cloudiac.tfvars.json \
          && \
          terraform show -no-color -json _cloudiac.tfplan >../../tfplan.json
    ansiblePlay:
      after:
        - |
          test -f ansible/import.yml || cd /cloudiac/workspace/code
          bash ansible/run.sh import.yml
          pwd

destroy:
  steps:
    terraformDestroy:
      before:
        - |
          test -f ansible/export.yml || cd /cloudiac/workspace/code
          bash ansible/run.sh export.yml
          pwd
